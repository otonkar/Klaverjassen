###
 # Docker compose for setup Django backend Only
 #
 # Docker compose file that belongs to tutorial
 # https://www.youtube.com/watch?v=nh1ynJGJuT8
 #
 # make and start:                      docker-compose -f docker-compose_backend_dev.yml up --build
 #
 # remove old images using:             docker-compose -f docker-compose_backend_dev.yml rm
 # Do this when recreate error occurs
 #
 # run the images a being composed:     docker-compose -f docker-compose_backend_dev.yml run -p 7000:8000  app sh
 #
 # Get into a running container
 #  docker exec -it klaverjas_django_dev /bin/sh
 #
 # Run the image
 #  docker run -it django-base /bin/sh
###

version: '3.8'

services:

  daphne:
    image: django-base
    # build:
    #   context: ./backend                  # path to the Dockerfile or URL to respository
    #   dockerfile: Dockerfile_daphne       # default is Dockerfile
    container_name: klaverjas_daphne_dev    # specifies the name of the container that is created
    working_dir: /apps/back1
    restart: always
    ports:
      - "6000:6000"
    # environment:
      # - REDIS_HOST=redis
    # env_file:
    #   - ./development.env                   # load db user, password and db name
    networks:
      - klaverjas_network
    volumes:                              
      - ./backend:/apps 
    command: sh -c "run_daphne_dev.sh"
    depends_on:
      - redis
  
  # worker:
  #   image: django-base
  #   container_name: klaverjas_worker_dev    # specifies the name of the container that is created
  #   working_dir: /apps/back1
  #   restart: always
  #   environment:
  #     - REDIS_HOST=redis
  #   env_file:
  #     - ./development.env                   # load db user, password and db name
  #   networks:
  #     - klaverjas_network
  #   volumes:                              
  #     - ./backend:/apps 
  #   command: sh -c "python manage.py runworker"
  #   depends_on:
  #     - redis
  

  django:                                # name of this services
    image: django-base
    # build:
    #   context: ./backend                  # path to the Dockerfile or URL to respository
    #   dockerfile: Dockerfile_django1      # default is Dockerfile
    # image: django-backend_dev             # specify the image that must be used
    container_name: klaverjas_django_dev    # specifies the name of the container that is created
    restart: always
    ports:
      - 5000:5000                          # map external port 7000 to internal port 7000, to use like localhost:7000
    # env_file:
    #   - ./development.env                   # load db user, password and db name
    networks:
      - klaverjas_network
    volumes:                              # Note volumes are read-only for users and rw for root (not executable !!)
      - ./backend:/apps                   # maps the backend map to the /apps map in the container to sync realtime. !! align with the dockerfile
    command: sh -c "run_dev.sh"           # For development
    depends_on:
      - psql
      - redis
      - daphne


  psql:
    image: postgres
    container_name: klaverjas_psql_dev 
    restart: always
    ports:
      - "5432:5432"
    networks:
      - klaverjas_network
    environment:
      - PGDATA=/var/lib/postgresql/data       # The folder in the image where the data is stored
      # - POSTGRES_USER:postgres
      # - POSTGRES_PASSWORD:Tonsberg01
      # - POSTGRES_DB:db_klaverjas
    env_file:
      - ./psql_dev.env                        # load db user, password and db name
    volumes:
      - ./psql-data:/var/lib/postgresql/data    # store postgres data on a folder of the server

  redis:
    image: redis
    container_name: klaverjas_redis_dev 
    networks:
      - klaverjas_network
    ports:
      - "6379:6379"

  front:
    # image: django-base
    build:
      context: ./frontend                  # path to the Dockerfile or URL to respository
      dockerfile: Dockerfile_front_dev       # default is Dockerfile
    container_name: klaverjas_front_dev    # specifies the name of the container that is created
    # working_dir: /apps/back1
    restart: always
    ports:
      - "8080:8080"
    environment:
      - VUE_APP_URL_API_BASE=http://localhost:5000/
      - VUE_APP_URL_WEBSOCKET=ws:localhost:5000/ws/game/
    # env_file:
    #   - ./development.env                   # load db user, password and db name
    networks:
      - klaverjas_network
    # volumes:                              
    #   - ./backend:/apps 
    command: sh -c "npm run serve"
    depends_on:
      - redis

networks:
  klaverjas_network:








